# åŸºäºAQRæƒé‡å›¾æ¸²æŸ“æœºåˆ¶çš„CMTé…ç½®æ–‡ä»¶ (800Ã—320åˆ†è¾¨ç‡)
# ç»§æ‰¿voxel0100_r50_800x320åŸºç¡€é…ç½®

# ç»§æ‰¿åŸå§‹é…ç½®
_base_ = ['./cmt_voxel0100_r50_800x320_cbgs.py']

# =============================================================================
# ğŸ”¥ è¶…å‚æ•°å’ŒåŠŸèƒ½æ§åˆ¶ç´¢å¼•
# =============================================================================
# 
# ğŸ“Œ AQR æ€»å¼€å…³ï¼ˆåœ¨ç¬¬65è¡Œï¼‰
#   enable_aqr=True              # AQRåŠŸèƒ½çš„å…¨å±€å¼€å…³
#
# ğŸ“Œ çª—å£å¤§å°æ§åˆ¶ï¼ˆåœ¨ç¬¬79è¡Œï¼‰
#   window_sizes=[8, 5]          # [camera_window, lidar_window] å±€éƒ¨çª—å£å¤§å°
#
# ğŸ“Œ é«˜æ–¯çª—å£å¼€å…³ï¼ˆåœ¨ç¬¬189è¡Œ - æœ€é‡è¦ï¼ï¼‰
#   use_gaussian_window=False    # False=å‡åŒ€çª—å£ï¼ŒTrue=é«˜æ–¯è¡°å‡çª—å£
#   gaussian_sigma=2.0           # é«˜æ–¯æ ‡å‡†å·®ï¼ˆä»…use_gaussian_window=Trueæ—¶ç”Ÿæ•ˆï¼‰
#
# ğŸ“Œ æ¸²æŸ“æ–¹æ³•å¼€å…³ï¼ˆåœ¨ç¬¬122è¡Œï¼‰
#   render_method='gaussian'     # ['gaussian', 'bilinear', 'direct', 'distance_weighted']
#
# ğŸ“Œ bias_scale æ§åˆ¶ï¼ˆåœ¨ç¬¬180-183è¡Œï¼‰
#   bias_scale=2.5               # åˆå§‹å€¼ï¼ˆæ³¨æ„åŠ›åç½®çš„å¼ºåº¦ï¼‰
#   learnable_scale=True         # True=å¯å­¦ä¹ ä¼šæ›´æ–°ï¼ŒFalse=å›ºå®šå€¼
#   min_scale=0.5                # æœ€å°scaleï¼ˆé˜²æ­¢é€€åŒ–ï¼‰
#   max_scale=5.0                # æœ€å¤§scaleï¼ˆé˜²æ­¢softmaxé¥±å’Œï¼‰
#
# ğŸ“Œ è°ƒè¯•æ§åˆ¶ï¼ˆåœ¨ç¬¬66è¡Œã€ç¬¬195-196è¡Œï¼‰
#   debug_mode=True              # è°ƒè¯•æ¨¡å¼ï¼ˆç”Ÿäº§ç¯å¢ƒå»ºè®®å…³é—­ï¼‰
#   debug_print=True             # å¯ç”¨biasç»Ÿè®¡ä¿¡æ¯æ‰“å°
#   print_interval=1000         # æ¯1000ä¸ªiterationæ‰“å°ä¸€æ¬¡
#
# =============================================================================

# ğŸ”¥ ä¼˜åŒ–å™¨é…ç½®ï¼šå†»ç»“éª¨å¹²+AQRå­¦ä¹ 
optimizer = dict(
    type='AdamW',
    lr=0.0001,                       # ğŸ”¥ åŸºç¡€å­¦ä¹ ç‡ 1e-4ï¼ˆå› ä¸ºéª¨å¹²å†»ç»“ï¼‰
    paramwise_cfg=dict(
        custom_keys={
            # === éª¨å¹²ç½‘ç»œï¼šå®Œå…¨å†»ç»“ ===
            'img_backbone': dict(lr_mult=0.0),          # å›¾åƒéª¨å¹²ï¼š0å­¦ä¹ ç‡ï¼ˆå®Œå…¨å†»ç»“ï¼‰
            'pts_backbone': dict(lr_mult=0.0),          # ç‚¹äº‘éª¨å¹²ï¼š0å­¦ä¹ ç‡ï¼ˆå®Œå…¨å†»ç»“ï¼‰
            'pts_voxel_encoder': dict(lr_mult=0.0),     # ä½“ç´ ç¼–ç å™¨ï¼šå†»ç»“
            'pts_middle_encoder': dict(lr_mult=0.0),    # ä¸­é—´ç¼–ç å™¨ï¼šå†»ç»“
            
            # === Neckå±‚ï¼šå¾®è°ƒ ===
            'img_neck': dict(lr_mult=0.05),             # å›¾åƒNeckï¼š5%åŸºç¡€å­¦ä¹ ç‡
            'pts_neck': dict(lr_mult=0.05),             # ç‚¹äº‘Neckï¼š5%åŸºç¡€å­¦ä¹ ç‡
            
            # === Transformerç»„ä»¶ï¼šä¿æŒå­¦ä¹  ===
            'transformer': dict(lr_mult=0.5),           # Transformerï¼š50%åŸºç¡€å­¦ä¹ ç‡
            'query_embed': dict(lr_mult=0.3),           # æŸ¥è¯¢åµŒå…¥ï¼š30%åŸºç¡€å­¦ä¹ ç‡
            'reference_points': dict(lr_mult=0.8),      # å‚è€ƒç‚¹ï¼š80%åŸºç¡€å­¦ä¹ ç‡
            
            # === AQRç»„ä»¶ï¼šå®Œå…¨å­¦ä¹  ===
            'aqr_weight_generator': dict(lr_mult=1.0),  # AQRæƒé‡ç”Ÿæˆå™¨ï¼š100%å­¦ä¹ ç‡
            'attention_bias_generator': dict(lr_mult=1.0),  # Attention Biasç”Ÿæˆå™¨ï¼š100%å­¦ä¹ ç‡
            'attention_bias_generator.bias_scale': dict(lr_mult=0.5),  # ğŸ”¥ bias_scaleï¼š50%å­¦ä¹ ç‡ï¼ˆæ›´ç¨³å®šï¼‰
        }
    ),
    weight_decay=0.01
)

# ğŸ”¥ å†»ç»“Backboneçš„normå±‚
model = dict(
    # === Image Backboneå†»ç»“ ===
    img_backbone=dict(
        frozen_stages=4,    # ğŸ”¥ ResNet50å®Œå…¨å†»ç»“ï¼ˆstage0-4å…¨éƒ¨å†»ç»“ï¼‰
        norm_eval=True,     # ğŸ”¥ BNä¿æŒevalæ¨¡å¼ï¼ˆä½¿ç”¨é¢„è®­ç»ƒç»Ÿè®¡é‡ï¼‰
    ),
    
    # === LiDAR Backboneå†»ç»“ ===
    pts_backbone=dict(
        frozen_stages=3,    # ğŸ”¥ SECONDå®Œå…¨å†»ç»“ï¼ˆ3å±‚å…¨éƒ¨å†»ç»“ï¼‰
    ),
    
    # === Neckå±‚ï¼ˆé€‰æ‹©æ€§å¾®è°ƒï¼‰===
    img_neck=dict(
        norm_eval=True,     # BNä¿æŒevalæ¨¡å¼
    ),
    pts_neck=dict(
        norm_eval=True,     # BNä¿æŒevalæ¨¡å¼
    ),
)

# ğŸ”¥ğŸ”¥ğŸ”¥ æ ¸å¿ƒAQRé…ç½®ï¼šå¿…é¡»æ”¾åœ¨æ–‡ä»¶æœ€åï¼Œç¡®ä¿è¦†ç›–baseä¸­çš„é»˜è®¤å€¼ï¼ ğŸ”¥ğŸ”¥ğŸ”¥
model = dict(
    pts_bbox_head=dict(
        _delete_=False,  # ğŸ”¥ ä¸åˆ é™¤æ•´ä¸ªheadï¼Œåªæ˜¯åˆå¹¶/è¦†ç›–å­—æ®µ
        
        # === AQRç‰¹å®šé…ç½®ï¼ˆè¦†ç›–baseä¸­çš„é»˜è®¤å€¼ï¼‰===
        enable_aqr=True,               # âœ… å¯ç”¨AQRæœºåˆ¶ï¼ˆå¯¹æ¯”å®éªŒï¼šAQRæ¨¡å‹ï¼‰
        debug_mode=True,              # è°ƒè¯•æ¨¡å¼ï¼ˆç”Ÿäº§ç¯å¢ƒå»ºè®®å…³é—­ï¼‰
        visualization_interval=100,    # å¯è§†åŒ–é—´éš”
        
        # ===================================================================
        # ğŸ”¥ AQR æƒé‡ç”Ÿæˆå™¨é…ç½®ï¼ˆæ ¸å¿ƒæ¨¡å—1ï¼‰
        # ===================================================================
        aqr_config=dict(
            _delete_=True,  # ğŸ”¥ åˆ é™¤baseä¸­çš„Noneï¼Œä½¿ç”¨å®Œæ•´çš„æ–°é…ç½®
            
            # ===========================================
            # ğŸ“‹ åŸºç¡€å‚æ•°
            # ===========================================
            embed_dims=256,           # åµŒå…¥ç»´åº¦
            window_sizes=[8, 5],      # ğŸ”¥ã€çª—å£å¤§å°æ§åˆ¶ã€‘[camera_window, lidar_window] - é’ˆå¯¹20Ã—50ç‰¹å¾å›¾ä¼˜åŒ–
            use_type_embed=True,      # ä½¿ç”¨ç±»å‹åµŒå…¥
            bev_feature_shape=(128, 128),  # ğŸ”¥ BEVç‰¹å¾å›¾å°ºå¯¸ï¼ˆvoxel_size=0.1, grid=1024, 1024/8=128ï¼‰
            pers_feature_shape=(6, 20, 50),  # ğŸ”¥ é€è§†ç‰¹å¾å›¾å°ºå¯¸ï¼ˆ800x320, 800/16=50, 320/16=20ï¼‰
            encoder_config=dict(
                type='PETRTransformerDecoder',
                return_intermediate=True,
                num_layers=1,         # æƒé‡ç”Ÿæˆåªéœ€1å±‚
                transformerlayers=dict(
                    type='PETRTransformerDecoderLayer',
                    with_cp=False,
                    attn_cfgs=[
                        dict(
                            type='PETRMultiheadFlashAttention',  # ğŸ”¥ ä½¿ç”¨FlashAttentionä¼˜åŒ–ï¼ˆæ ‡å‡†ç‰ˆæœ¬ï¼Œæ— éœ€FlashBiasï¼‰
                            embed_dims=256,
                            num_heads=4,      # æƒé‡ç”Ÿæˆä½¿ç”¨è¾ƒå°‘çš„æ³¨æ„åŠ›å¤´
                            dropout=0.1,
                            # use_flashbias=True  # âŒ ä¸éœ€è¦ï¼AQRæƒé‡ç”Ÿæˆå™¨æ²¡æœ‰attention_bias
                        ),
                    ],
                    ffn_cfgs=dict(
                        type='FFN',
                        embed_dims=256,
                        feedforward_channels=1024,
                        num_fcs=2,
                        ffn_drop=0.1,
                        act_cfg=dict(type='ReLU', inplace=True)
                    ),
                    feedforward_channels=1024,
                    operation_order=('cross_attn', 'norm', 'ffn', 'norm')
                )
            )
        ),
        
        # ===================================================================
        # ğŸ”¥ æƒé‡å›¾æ¸²æŸ“å™¨é…ç½®ï¼ˆæ ¸å¿ƒæ¨¡å—2ï¼‰
        # ===================================================================
        renderer_config=dict(
            _delete_=True,  # ğŸ”¥ åˆ é™¤baseä¸­çš„Noneï¼Œä½¿ç”¨å®Œæ•´çš„æ–°é…ç½®
            
            # ===========================================
            # ğŸ“‹ æ¸²æŸ“æ–¹æ³•æ§åˆ¶
            # ===========================================
            render_method='gaussian',      # ğŸ”¥ã€æ¸²æŸ“æ–¹æ³•å¼€å…³ã€‘: ['gaussian', 'bilinear', 'direct', 'distance_weighted']
            
            # ===========================================
            # ğŸ“‹ é«˜æ–¯æ¸²æŸ“å‚æ•°ï¼ˆrender_method='gaussian'æ—¶ä½¿ç”¨ï¼‰
            # ===========================================
            gaussian_sigma=1.0,            # ğŸ”¥ã€é«˜æ–¯æ ‡å‡†å·®ã€‘é’ˆå¯¹å°ç‰¹å¾å›¾ä¼˜åŒ–ï¼ˆé™ä½=æ›´å°–é”ï¼Œå‡é«˜=æ›´å¹³æ»‘ï¼‰
            
            # ===========================================
            # ğŸ“‹ åŒçº¿æ€§æ¸²æŸ“å‚æ•°ï¼ˆrender_method='bilinear'æ—¶ä½¿ç”¨ï¼‰
            # ===========================================
            bilinear_radius=1.5,           # ğŸ”¥ã€åŒçº¿æ€§æ’å€¼åŠå¾„ã€‘
            
            # ===========================================
            # ğŸ“‹ å…¶ä»–æ¸²æŸ“å‚æ•°
            # ===========================================
            distance_decay=0.8,            # è·ç¦»è¡°å‡å› å­
            min_weight_threshold=0.01,     # æœ€å°æƒé‡é˜ˆå€¼
            bev_feature_shape=(128, 128),  # ğŸ”¥ BEVç‰¹å¾å›¾å°ºå¯¸ï¼ˆåŸºäºvoxel_size=0.1ï¼‰
            pers_feature_shape=(6, 20, 50), # ğŸ”¥ é€è§†ç‰¹å¾å›¾å°ºå¯¸ (views, h, w) - é’ˆå¯¹800Ã—320
            normalize_weights=True         # ä½¿ç”¨è½»åº¦è£å‰ª
        ),
        
        # ğŸ”¥ ç‰¹å¾è°ƒåˆ¶æ¨¡å¼é€‰æ‹©ï¼ˆæ—§æ–¹æ¡ˆï¼Œå·²åºŸå¼ƒï¼Œä½¿ç”¨attention_biasæ›¿ä»£ï¼‰
        use_simple_modulation=False,     # False=å®Œæ•´æ¨¡å¼(æ¨è), True=ç®€åŒ–æ¨¡å¼
        
        # ç‰¹å¾è°ƒåˆ¶å™¨é…ç½®ï¼ˆæ—§æ–¹æ¡ˆï¼Œä»…åœ¨å®Œæ•´æ¨¡å¼use_simple_modulation=Falseæ—¶ä½¿ç”¨ï¼‰
        modulator_config=dict(
            _delete_=True,  # ğŸ”¥ åˆ é™¤baseä¸­çš„Noneï¼Œä½¿ç”¨å®Œæ•´çš„æ–°é…ç½®
            type='FeatureModulator',
            modulation_type='element_wise',  # è°ƒåˆ¶ç±»å‹: ['element_wise', 'channel_wise', 'adaptive']
            normalize_weights=False,         # ç¦ç”¨FeatureModulatorå†…éƒ¨çš„å½’ä¸€åŒ–ï¼ˆWeightRendererå·²å¤„ç†ï¼‰
            residual_connection=True,        # ğŸ›¡ï¸ æ®‹å·®è¿æ¥ï¼ˆé˜²æ­¢ç‰¹å¾æ¶ˆå¤±ï¼‰
            residual_weight=0.7,             # ğŸ”¥ å¼ºåŒ–æ®‹å·®ä¿æŠ¤ï¼šä¿ç•™70%åŸå§‹ç‰¹å¾
            learnable_modulation=False,      # å¯å­¦ä¹ è°ƒåˆ¶å‚æ•°
            activation='none'                # æ¿€æ´»å‡½æ•°: ['none', 'sigmoid', 'tanh', 'relu']
        ),
        
        # ===================================================================
        # ğŸ”¥ Attention Bias é…ç½®ï¼ˆæ ¸å¿ƒæ¨¡å—3 - æ–°æ–¹æ¡ˆï¼Œæ¨èï¼‰
        # ===================================================================
        attention_bias_config=dict(
            _delete_=True,  # ğŸ”¥ åˆ é™¤baseä¸­çš„Noneï¼Œä½¿ç”¨å®Œæ•´çš„æ–°é…ç½®
            type='AttentionBiasGenerator',
            
            # ===========================================
            # ğŸ“‹ ç‰¹å¾å›¾å½¢çŠ¶ï¼ˆå¿…é¡»ä¸renderer_configä¸€è‡´ï¼‰
            # ===========================================
            bev_feature_shape=(128, 128),    # BEVç‰¹å¾å›¾å°ºå¯¸ï¼ˆä¸renderer_configä¿æŒä¸€è‡´ï¼‰
            pers_feature_shape=(6, 20, 50),  # é€è§†ç‰¹å¾å›¾å°ºå¯¸ï¼ˆä¸renderer_configä¿æŒä¸€è‡´ï¼‰
            
            # ===========================================
            # ğŸ“‹ å±€éƒ¨çª—å£æ§åˆ¶ï¼ˆä¸window_sizes[0]ä¿æŒä¸€è‡´ï¼‰
            # ===========================================
            window_size=8,                   # ğŸ”¥ã€å±€éƒ¨çª—å£å¤§å°ã€‘ï¼ˆä¸camera_window=8ä¿æŒä¸€è‡´ï¼‰
            
            # ===========================================
            # ğŸ“‹ bias_scale å‚æ•°æ§åˆ¶
            # ===========================================
            bias_scale=2.5,                  # ğŸ”¥ã€biasç¼©æ”¾å› å­åˆå§‹å€¼ã€‘ï¼ˆæ§åˆ¶æ³¨æ„åŠ›åç½®çš„å¼ºåº¦ï¼‰
            learnable_scale=True,            # ğŸ”¥ã€è®©bias_scaleå¯å­¦ä¹ ã€‘ï¼ˆTrue=ä¼šæ›´æ–°ï¼ŒFalse=å›ºå®šå€¼ï¼‰
            min_scale=0.5,                   # ğŸ”¥ã€æœ€å°scaleã€‘ï¼ˆé˜²æ­¢é€€åŒ–ï¼‰
            max_scale=5.0,                   # ğŸ”¥ã€æœ€å¤§scaleã€‘ï¼ˆé˜²æ­¢softmaxé¥±å’Œï¼‰
            
            # ===========================================
            # ğŸ“‹ é«˜æ–¯çª—å£å¼€å…³ï¼ˆé‡è¦ï¼ï¼‰
            # ===========================================
            use_local_bias=True,             # ğŸ”¥ã€ä½¿ç”¨å±€éƒ¨çª—å£biasã€‘ï¼ˆTrue=åªåœ¨çª—å£å†…è®¡ç®—ï¼ŒFalse=å…¨å±€è®¡ç®—ï¼‰
            use_gaussian_window=False,       # ğŸ”¥ğŸ”¥ğŸ”¥ã€é«˜æ–¯çª—å£å¼€å…³ã€‘ï¼ˆFalse=å‡åŒ€çª—å£ï¼ŒTrue=é«˜æ–¯è¡°å‡çª—å£ï¼‰
            gaussian_sigma=2.0,              # ğŸ”¥ã€é«˜æ–¯æ ¸æ ‡å‡†å·®ã€‘ï¼ˆä»…use_gaussian_window=Trueæ—¶ç”Ÿæ•ˆï¼Œ800x320ç”¨2.0ï¼‰
            
            # ===========================================
            # ğŸ“‹ è°ƒè¯•å’Œæ€§èƒ½æ§åˆ¶
            # ===========================================
            debug_print=True,                # ğŸ”¥ã€å¯ç”¨è°ƒè¯•æ‰“å°ã€‘ï¼ˆæ˜¾ç¤ºbiasç»Ÿè®¡ä¿¡æ¯ï¼‰
            print_interval=1000,             # ğŸ”¥ã€æ‰“å°é—´éš”ã€‘æ¯1000ä¸ªiterationæ‰“å°ä¸€æ¬¡
            fp16=True                        # ğŸ”¥ã€ä½¿ç”¨FP16ã€‘ä»¥èŠ‚çœå†…å­˜
        ),
    )
)

# ğŸ”¥ åˆ†å¸ƒå¼è®­ç»ƒé…ç½®ï¼šå…è®¸æœªä½¿ç”¨çš„å‚æ•°ï¼ˆAQRå¯èƒ½åœ¨æŸäº›æƒ…å†µä¸‹ä¸è¢«è°ƒç”¨ï¼‰
find_unused_parameters = True

# AQR 三次实验完整对比分析 🔬

## 📋 实验配置总览

| 实验 | enable_aqr | max_weight_clamp | residual_weight | 理论最大增强 | 预期Camera调制 |
|-----|-----------|------------------|-----------------|-------------|-----------------|
| **实验0: 基线** | ❌ False | - | - | 1.0× | 0% |
| **实验1: AQR (1.5+0.7)** | ✅ True | 1.5 | 0.7 | 1.15× | ~29-33% |
| **实验2: AQR (2.5+0.6)** | ✅ True | 2.5 | 0.6 | 1.6× | ~36% |

**理论最大增强计算：**
```python
公式：residual_weight + max_weight_clamp × (1 - residual_weight)

实验1 (1.5+0.7)：
  = 0.7 + 1.5 × 0.3 = 1.15×

实验2 (2.5+0.6)：
  = 0.6 + 2.5 × 0.4 = 1.6×
```

---

## 🏆 核心性能对比

### 1. 主要指标对比

| 指标 | 基线 | AQR(1.5+0.7) | AQR(2.5+0.6) | 最优 | 分析 |
|-----|------|--------------|-------------|------|-----|
| **mAP** | **65.75%** 🥇 | **64.49%** | **63.97%** | **基线** | AQR越激进越差 |
| **NDS** | **69.08%** 🥇 | **68.49%** | **68.25%** | **基线** | AQR损失0.83% |
| mATE | 0.3353 | 0.3390 | 0.3373 | 基线 | 定位误差 |
| mASE | 0.2493 | 0.2506 | 0.2500 | 基线 | 尺度误差 |
| mAOE | 0.3339 | 0.3226 | 0.3259 | AQR1.5 | 方向略好 |
| mAVE | 0.2715 | 0.2738 | 0.2731 | 基线 | 速度误差 |
| mAAE | 0.1899 | 0.1894 | 0.1876 | AQR2.5 | 属性略好 |

**🚨 核心发现：**
```
性能排名：
  🥇 基线（无AQR）：   mAP 65.75%, NDS 69.08%  ✅ 最佳
  🥈 AQR 1.5+0.7：     mAP 64.49%, NDS 68.49%  ⚠️ 下降1.26%
  🥉 AQR 2.5+0.6：     mAP 63.97%, NDS 68.25%  ❌ 下降1.78%

关键规律：
  ✅ 1.5+0.7（温和）> 2.5+0.6（激进）
  ✅ AQR配置越激进，性能越差！
  ✅ 残差保护越多越好（0.7 > 0.6）
```

---

## 🔍 各类别AP详细对比

| 类别 | 基线AP | AQR(1.5+0.7) | AQR(2.5+0.6) | 最优 | AQR1.5差异 | AQR2.5差异 |
|-----|--------|-------------|-------------|------|-----------|-----------|
| **car** | **85.9%** | **85.3%** | **85.9%** | 基线/AQR2.5 | -0.6% | 0.0% |
| **truck** | **60.9%** | **60.2%** | **60.9%** | 基线/AQR2.5 | -0.7% | 0.0% |
| **bus** | **73.5%** | **72.7%** | **73.5%** | 基线/AQR2.5 | -0.8% | 0.0% |
| **trailer** | **42.3%** | **42.3%** | **42.3%** | 相同 | 0.0% | 0.0% |
| **construction_vehicle** | **30.1%** | **29.5%** | **30.1%** | 基线/AQR2.5 | -0.6% | 0.0% |
| **pedestrian** | **84.0%** | **82.6%** | **84.0%** | 基线/AQR2.5 | **-1.4%** ❌ | 0.0% |
| **motorcycle** | **72.9%** | **70.6%** | **72.9%** | 基线/AQR2.5 | **-2.3%** ❌ | 0.0% |
| **bicycle** | **64.1%** | **60.9%** | **64.1%** | 基线/AQR2.5 | **-3.2%** ❌❌ | 0.0% |
| **traffic_cone** | **72.7%** | **70.0%** | **72.7%** | 基线/AQR2.5 | **-2.7%** ❌ | 0.0% |
| **barrier** | **71.1%** | **70.9%** | **71.1%** | 基线/AQR2.5 | -0.2% | 0.0% |

**🚨 最严重问题：小目标受损（所有AQR配置）**
```
最受影响的类别（AQR 1.5+0.7）：
  1. bicycle:       -3.2% ❌❌❌ （最严重）
  2. traffic_cone:  -2.7% ❌❌
  3. motorcycle:    -2.3% ❌❌
  4. pedestrian:    -1.4% ❌

大目标相对稳定：
  - car, truck, bus: -0.6% ~ -0.8%
  - trailer: 持平
```

**🎯 关键发现：**
- **✅ AQR 1.5+0.7（温和）比 2.5+0.6（激进）性能好0.52% mAP**
- **✅ 残差保护很重要：0.7 > 0.6**
- **❌ 但所有AQR配置都无法超越基线**

---

## 📊 训练成本对比

| 指标 | 基线 | AQR(1.5+0.7) | AQR(2.5+0.6) | 差异 |
|-----|------|-------------|-------------|------|
| **训练时间** | **56分钟** | **~140分钟** | **~142分钟** | AQR慢**2.5倍**! |
| **内存占用** | **21GB** | **23GB** | **23GB** | AQR多**2GB** |
| **每iter时间** | **0.64s** | **~1.84s** | **~1.84s** | AQR慢**2.9倍**! |

**成本结论：AQR代价巨大但收益为负！**

---

## 🔬 AQR权重分析

### 实验1 (1.5+0.7) 的AQR权重统计

```python
lidar_weights_stats (Forward #3000):
  mean: 0.7664      # LiDAR平均权重76.6%
  std: 0.0619       # 标准差6.2%
  min: 0.5012       # 最小50.1%
  max: 0.8816       # 最大88.2%

camera_weights_stats (Forward #3000):
  mean: 0.6974      # Camera平均权重69.7%
  std: 0.0617       # 标准差6.2%
  min: 0.5025       # 最小50.3%
  max: 0.8328       # 最大83.3%

modulation_effect_pers (Forward #3000):
  mean_change: 0.002281      # Camera特征平均变化+0.23%
  std_change: 0.009506       # 标准差0.95%
  max_change: 6.817721       # 最大变化682%
  relative_change: 0.286392  # 相对变化28.6%
```

### 实验2 (2.5+0.6) 的AQR权重统计

```python
camera_weights_stats:
  mean: ~0.70
  max: 70.83 (bug修复前)  ❌ 过高！

modulation_effect_pers:
  relative_change: 0.361     # 36.1%调制强度
```

---

## 🎯 核心问题诊断

### 问题1：为什么1.5+0.7比2.5+0.6更差？

**分析：**
```
理论分析：
  1.5+0.7: 最大增强1.15×，保护70%原始特征 → 温和
  2.5+0.6: 最大增强1.6×，保护60%原始特征  → 激进

实际表现：
  1.5+0.7: mAP 64.49% ❌ 最差
  2.5+0.6: mAP 63.97% ⚠️ 次差
  基线:    mAP 65.75% ✅ 最好

可能原因：
  1. Camera权重图渲染BUG（1.5配置时未修复）
     → Camera max=70.83导致过度调制
  
  2. 残差权重0.7保护过多
     → AQR学习到的权重被稀释，效果不明显
  
  3. 小目标对权重调制极其敏感
     → bicycle/motorcycle/traffic_cone大幅下降
```

### 问题2：为什么AQR整体失败？

**核心原因：**
```
1. Camera特征已经很好（基线性能高）
   → 强行调制反而引入噪声

2. 权重图渲染方式可能不当
   → 高斯散布导致空间对应关系被破坏

3. 小目标信号微弱
   → 特征调制放大了噪声，淹没了真实信号

4. 训练时间太短（1 epoch）
   → AQR需要更多时间学习有效的权重分布
```

---

## 💡 优化建议

### 方案1：极保守配置（尝试挽救AQR）

```python
max_weight_clamp=1.2    # ⬇️ 从1.5降到1.2（更温和）
residual_weight=0.85    # ⬆️ 从0.7提高到0.85（更多保护）

理论最大增强：
  = 0.85 + 1.2 × 0.15 = 1.03×  （仅增强3%）

预期：
  - mAP: 65.0-65.5%（接近基线）
  - 小目标损失减少
  - 但可能AQR完全无效果
```

### 方案2：改进权重渲染策略

```python
# 当前：高斯核散布（可能破坏空间对应）
gaussian_sigma=2.0

# 建议：直接赋值或极小范围
render_method='direct'      # 直接赋值，不散布
# 或
gaussian_sigma=0.5          # 极小范围散布
```

### 方案3：延长训练时间

```python
total_epochs = 6    # 从1增加到6
  
# AQR需要充分学习才能发挥作用
```

### 方案4：放弃AQR（推荐）

```
基于三次实验的铁证：
  - 基线性能最好
  - AQR代价巨大（2.5倍训练时间）
  - AQR收益为负（性能下降1-2%）

建议：
  直接使用基线模型，不引入AQR机制
```

---

## 📈 实验结论

### 核心结论

1. **AQR在此任务上完全失败** ❌
   - 三次实验无一超越基线
   - 配置越激进，性能越差
   - 训练成本增加2.5倍

2. **小目标是最大受害者** ❌
   - bicycle下降3.2%
   - motorcycle下降2.3%
   - traffic_cone下降2.7%
   - 这些是最需要提升的类别！

3. **Camera特征已经很好** ✅
   - 基线性能65.75% mAP
   - 强行调制引入噪声
   - 得不偿失

4. **1 epoch训练可能不够** ⚠️
   - AQR需要充分学习权重分布
   - 但考虑到2.5倍时间成本
   - 延长训练不经济

### 最终建议

**🎯 放弃AQR，使用基线模型！**

理由：
1. 性能：基线最优（65.75% mAP）
2. 效率：训练时间最短（56分钟）
3. 成本：内存占用最小（21GB）
4. 稳定：所有类别均衡发展

---

## 📊 性能对比图表

```
mAP性能对比：
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
基线     ████████████████████████ 65.75% ✅
AQR1.5   ███████████████████████  64.49% ⚠️
AQR2.5   ██████████████████████   63.97% ❌
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

训练时间对比：
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
基线     ████ 56分钟  ✅
AQR1.5   ██████████ 140分钟 ❌ (2.5倍)
AQR2.5   ██████████ 142分钟 ❌ (2.5倍)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

小目标AP变化（相对基线）：
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
bicycle (AQR1.5):      -3.2% ████ ❌❌❌
traffic_cone (AQR1.5): -2.7% ███ ❌❌
motorcycle (AQR1.5):   -2.3% ███ ❌❌
pedestrian (AQR1.5):   -1.4% ██ ❌
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

---

**🎯 最终裁决：AQR权重图渲染机制在800×320分辨率、1 epoch训练条件下，未能提升性能，反而带来显著性能下降和成本增加。建议放弃AQR，使用基线CMT模型。**


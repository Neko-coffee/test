# AQRäº”å¤§æ ¸å¿ƒé—®é¢˜æ·±åº¦åˆ†æ ğŸ”¬

ä¸»äººæå‡ºçš„5ä¸ªé—®é¢˜è§¦åŠäº†AQRæœºåˆ¶çš„æ ¹æœ¬æ€§é—®é¢˜ï¼è®©æˆ‘é€ä¸€æ·±å…¥å‰–æã€‚

---

## é—®é¢˜1: é«˜æ–¯æ•£å¸ƒèŒƒå›´æ˜¯å¦åˆç†ï¼Ÿ ğŸ¯

### å½“å‰é…ç½®
```python
# weight_renderer.py
gaussian_sigma = 2.0  # å½“å‰ä½¿ç”¨çš„Ïƒå€¼
```

### å¯è§†åŒ–åˆ†æ

**å·²åˆ›å»ºå¯è§†åŒ–è„šæœ¬ï¼š**
```bash
python tools/visualize_gaussian_kernel.py
```

**ç†è®ºåˆ†æï¼š**

```
é«˜æ–¯æ ¸ç†è®ºï¼š
  - 3ÏƒåŸåˆ™ï¼š99.7%çš„æƒé‡åœ¨3ÏƒèŒƒå›´å†…
  - Ïƒ=2.0 â†’ 3Ïƒ=6åƒç´ 

åœ¨BEVç‰¹å¾å›¾(180Ã—180)ä¸Šï¼š
  - æ¯åƒç´ ä»£è¡¨ï¼š108m / 180px = 0.6m
  - 3Ïƒå½±å“èŒƒå›´ï¼š6px Ã— 0.6m/px = 3.6m
  
åœ¨é€è§†ç‰¹å¾å›¾(6Ã—40Ã—100)ä¸Šï¼š
  - æ¯åƒç´ ä»£è¡¨çº¦1.35mï¼ˆæ°´å¹³ï¼‰
  - 3Ïƒå½±å“èŒƒå›´ï¼š6px Ã— 1.35m/px â‰ˆ 8.1m
```

**é—®é¢˜å‘ç°ï¼š**

```
âŒ Ïƒ=2.0å¯èƒ½è¿‡å¤§ï¼š
  1. BEVä¸Šå½±å“åŠå¾„3.6m
     â†’ å¯¹bicycle(å°ºå¯¸1.7mÃ—0.6m)è¿‡å¤§
     â†’ å¯¹traffic_cone(é«˜0.5m)ä¸¥é‡è¿‡å¤§
     
  2. é€è§†ç‰¹å¾å›¾ä¸Šå½±å“åŠå¾„8.1m
     â†’ è¿œè¶…å°ç›®æ ‡çš„å®é™…å°ºå¯¸
     â†’ å¯¼è‡´æƒé‡"æ¨¡ç³Š"åˆ°å‘¨å›´ç¯å¢ƒ
     
  3. é«˜æ–¯æ•£å¸ƒå‡è®¾ä¸é€‚åˆå°ç›®æ ‡
     â†’ å°ç›®æ ‡éœ€è¦æ›´"å°–é”"çš„æƒé‡åˆ†å¸ƒ
     â†’ å¤§ç›®æ ‡æ‰é€‚åˆå¹³æ»‘çš„é«˜æ–¯åˆ†å¸ƒ
```

**å»ºè®®æ”¹è¿›ï¼š**

```python
# æ–¹æ¡ˆ1ï¼šæ ¹æ®ç›®æ ‡å°ºå¯¸åŠ¨æ€è°ƒæ•´Ïƒ
def adaptive_gaussian_sigma(object_size):
    """
    object_size: ç›®æ ‡çš„BEVå°ºå¯¸(m)
    """
    if object_size < 2.0:  # å°ç›®æ ‡
        return 1.0  # Ïƒ=1.0, å½±å“åŠå¾„1.8m
    elif object_size < 5.0:  # ä¸­ç­‰ç›®æ ‡
        return 1.5  # Ïƒ=1.5, å½±å“åŠå¾„2.7m
    else:  # å¤§ç›®æ ‡
        return 2.0  # Ïƒ=2.0, å½±å“åŠå¾„3.6m

# æ–¹æ¡ˆ2ï¼šä½¿ç”¨æ›´å°–é”çš„æ ¸å‡½æ•°
def sharp_kernel(distance, threshold=2.0):
    """
    ä½¿ç”¨åˆ†æ®µå‡½æ•°ä»£æ›¿é«˜æ–¯æ ¸
    """
    if distance < threshold:
        return 1.0
    else:
        return np.exp(-(distance - threshold)**2)
```

---

## é—®é¢˜2: MoMEæ˜¯å¦ä½¿ç”¨DNï¼ˆå»å™ªè®­ç»ƒï¼‰ï¼Ÿ ğŸ”

### è°ƒæŸ¥ç»“æœ

**âœ… å·²ç¡®è®¤ï¼šMoME **ä¸ä½¿ç”¨DNè®­ç»ƒ**ï¼**

```python
# è¯æ®1ï¼šé…ç½®æ–‡ä»¶ä¸­æ— DNç›¸å…³å‚æ•°
CMTé…ç½®ï¼š
  noise_scale = 1.0
  dn_weight = 1.0
  scalar = 10
  split = 0.75
  
MoMEé…ç½®ï¼š
  âŒ æ— è¿™äº›å‚æ•°

# è¯æ®2ï¼šqueryæ•°é‡å¯¹æ¯”
CMT:
  é…ç½®: num_query = 900
  å®é™…è®­ç»ƒ: 1730ä¸ª (900åŸå§‹ + 830 DNå¢åŠ )
  
MoME:
  é…ç½®: æ— æ˜ç¡®num_queryï¼ˆå¯èƒ½åœ¨å¤´éƒ¨å®šä¹‰ï¼‰
  å®é™…: é…ç½®å¤šå°‘å°±æ˜¯å¤šå°‘
```

### å½±å“åˆ†æ

```
DNè®­ç»ƒçš„ä½œç”¨ï¼š
  âœ… åŠ é€Ÿæ”¶æ•›ï¼šé€šè¿‡ç»™GTåŠ å™ªå£°ï¼Œæ¨¡å‹å­¦ä¹ å»å™ª
  âœ… æé«˜é²æ£’æ€§ï¼šè®­ç»ƒæ—¶è§è¿‡å¸¦å™ªå£°çš„ç›®æ ‡
  âœ… å¢å¼ºæ³›åŒ–ï¼šé™ä½å¯¹å®Œç¾anchorçš„ä¾èµ–
  
MoMEä¸ä½¿ç”¨DNæ„å‘³ç€ï¼š
  1. è®­ç»ƒå¯èƒ½æ›´æ…¢
  2. æ›´ä¾èµ–äºè‰¯å¥½çš„queryåˆå§‹åŒ–
  3. å¯¹é®æŒ¡ã€éƒ¨åˆ†å¯è§ç›®æ ‡å¯èƒ½ä¸å¤Ÿé²æ£’
  
ä½†MoMEä»ç„¶æˆåŠŸï¼Œè¯´æ˜ï¼š
  âœ… å¤šä¸“å®¶æœºåˆ¶æœ¬èº«å°±å¾ˆå¼ºå¤§
  âœ… DNä¸æ˜¯å¿…éœ€çš„ï¼ˆä½†æœ‰ç”¨ï¼‰
```

### å¯¹æˆ‘ä»¬çš„å¯ç¤º

```
âš ï¸ æˆ‘ä»¬çš„AQRåœ¨CMTä¸Šå¤±è´¥ï¼Œä½†MoMEæˆåŠŸï¼Œå¯èƒ½æ˜¯å› ä¸ºï¼š
  1. MoMEæ²¡æœ‰DNï¼Œqueryæ•°é‡æ›´å¯æ§
  2. MoMEçš„ä¸“å®¶é€‰æ‹©æ›´ç›´æ¥ï¼ˆargmaxï¼‰
  3. æˆ‘ä»¬çš„æƒé‡æ¸²æŸ“å¼•å…¥äº†é¢å¤–çš„å™ªå£°
  
ğŸ’¡ å»ºè®®ï¼š
  - å¯ä»¥å°è¯•åœ¨CMTä¸Šç¦ç”¨DNï¼Œçœ‹æ˜¯å¦æ”¹å–„AQRæ•ˆæœ
  - æˆ–è€…åœ¨AQRæƒé‡ç”Ÿæˆæ—¶è€ƒè™‘DN queryçš„å½±å“
```

---

## é—®é¢˜3: ç›´æ¥ä¹˜æƒé‡æ˜¯å¦æœ‰é—®é¢˜ï¼Ÿ ğŸš¨

### ä¸»äººçš„æ´å¯Ÿéå¸¸æ·±åˆ»ï¼

```python
ä¸»äººçš„ä¾‹å­ï¼š
  åŸå§‹ç‰¹å¾: channel_green = 1.0 â†’ æ¨¡å‹çŸ¥é“æ˜¯"æ ‘"
  è°ƒåˆ¶å:   channel_green = 1.5 â†’ æ¨¡å‹å¯èƒ½ä¸çŸ¥é“æ˜¯"æ ‘"äº†
  
è¿™è§¦åŠäº†ç‰¹å¾è°ƒåˆ¶çš„æœ¬è´¨é—®é¢˜ï¼
```

### æ·±åº¦åˆ†æ

#### é—®é¢˜Aï¼šç ´åç‰¹å¾çš„ç»Ÿè®¡åˆ†å¸ƒ

```python
# CNNå­¦åˆ°çš„æ˜¯ä»€ä¹ˆï¼Ÿ
è®­ç»ƒæ—¶çš„ç‰¹å¾åˆ†å¸ƒï¼š
  - ImageNeté¢„è®­ç»ƒï¼šç‰¹å¾å€¼é€šå¸¸åœ¨[-3, 3]ï¼ˆå½’ä¸€åŒ–åï¼‰
  - ç‰¹å®šé€šé“ç»„åˆä»£è¡¨ç‰¹å®šè¯­ä¹‰
  - ä¾‹å¦‚ï¼š[0, 1, 0] â†’ ç»¿è‰² â†’ æ ‘/è‰

è°ƒåˆ¶åçš„é—®é¢˜ï¼š
  - [0, 1.5, 0] â†’ è¶…å‡ºè®­ç»ƒåˆ†å¸ƒ
  - æ¨¡å‹å¯èƒ½ä»æœªè§è¿‡è¿™æ ·çš„ç‰¹å¾ç»„åˆ
  - å¯¼è‡´è¯¯åˆ¤æˆ–ç½®ä¿¡åº¦ä¸‹é™
```

**å®éªŒéªŒè¯ï¼ˆä½¿ç”¨å¯è§†åŒ–è„šæœ¬ï¼‰ï¼š**

```bash
python tools/visualize_gaussian_kernel.py
# æŸ¥çœ‹ feature_modulation_simulation.png
```

#### é—®é¢˜Bï¼šä¸åŒé€šé“çš„ä¸ä¸€è‡´è°ƒåˆ¶

```python
æƒé‡å›¾æ˜¯æ•´ä½“çš„ï¼ˆæ‰€æœ‰é€šé“å…±äº«ï¼‰ï¼š
  
  åŸå§‹ç‰¹å¾:
    R=0.2, G=1.0, B=0.1  â†’ "ç»¿è‰²æ ‘å¶"
    
  æƒé‡å›¾ = 1.5
  
  è°ƒåˆ¶å:
    R=0.3, G=1.5, B=0.15  â†’ ä»ç„¶æ˜¯ç»¿è‰²ï¼Œä½†æ¯”ä¾‹æ”¹å˜
    
é—®é¢˜ï¼š
  - ç‰¹å¾çš„ç›¸å¯¹å…³ç³»è¢«ä¿æŒï¼ˆè¿˜å¥½ï¼‰
  - ä½†ç»å¯¹å€¼å¯èƒ½è¶…å‡ºè®­ç»ƒèŒƒå›´ï¼ˆæœ‰é—®é¢˜ï¼‰
```

#### é—®é¢˜Cï¼šå°ç›®æ ‡æ›´æ•æ„Ÿ

```python
ä¸ºä»€ä¹ˆå°ç›®æ ‡å—å½±å“æ›´ä¸¥é‡ï¼Ÿ

1. ç‰¹å¾ç¨€ç–æ€§ï¼š
   - å¤§ç›®æ ‡ï¼šå¾ˆå¤šåƒç´ ï¼Œå¹³å‡åä»ç¨³å®š
   - å°ç›®æ ‡ï¼šåªæœ‰å‡ ä¸ªåƒç´ ï¼Œè°ƒåˆ¶ç›´æ¥å½±å“
   
2. èƒŒæ™¯å¹²æ‰°ï¼š
   - å¤§ç›®æ ‡ï¼šç›®æ ‡ç‰¹å¾è¿œå¼ºäºèƒŒæ™¯
   - å°ç›®æ ‡ï¼šä¸èƒŒæ™¯æ··åˆï¼Œè°ƒåˆ¶å¯èƒ½å¢å¼ºé”™è¯¯çš„èƒŒæ™¯
   
3. åˆ†è¾¨ç‡é™åˆ¶ï¼š
   - BEV 180Ã—180 å¯¹ bicycle(1.7m) åªæœ‰3ä¸ªåƒç´ 
   - Ïƒ=2çš„é«˜æ–¯æ ¸å½±å“6åƒç´ 
   - è°ƒåˆ¶èŒƒå›´ > ç›®æ ‡æœ¬èº«ï¼
```

### æ˜¯å¦çœŸçš„æœ‰é—®é¢˜ï¼Ÿ

```python
âœ… SE (Squeeze-and-Excitation) æ¨¡å—è¯æ˜é€šé“åŠ æƒæœ‰æ•ˆï¼š

SEæ¨¡å—çš„å·¥ä½œåŸç†ï¼š
  1. Global Average Pooling â†’ è·å–é€šé“å…¨å±€ä¿¡æ¯
  2. FC layers â†’ å­¦ä¹ é€šé“é‡è¦æ€§
  3. Sigmoid â†’ ç”Ÿæˆ[0,1]æƒé‡
  4. é€é€šé“ç›¸ä¹˜ â†’ è°ƒåˆ¶ç‰¹å¾
  
SE vs æˆ‘ä»¬çš„AQRï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ–¹é¢                â”‚ SE Module       â”‚ Our AQR         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æƒé‡èŒƒå›´            â”‚ [0, 1]          â”‚ [0, 2.5]        â”‚
â”‚ ä½œç”¨åŸŸ              â”‚ é€šé“çº§          â”‚ ç©ºé—´çº§          â”‚
â”‚ å¯å­¦ä¹ æ€§            â”‚ âœ… å…¨ç¨‹å¯å­¦ä¹    â”‚ âœ… æƒé‡å¯å­¦ä¹    â”‚
â”‚ è®­ç»ƒæ—¶è°ƒåˆ¶          â”‚ âœ… Yes          â”‚ âœ… Yes          â”‚
â”‚ æ®‹å·®è¿æ¥            â”‚ âœ… éšå¼         â”‚ âœ… æ˜¾å¼(0.7)    â”‚
â”‚ ç ´ååŸå§‹åˆ†å¸ƒï¼Ÿ      â”‚ âŒ ä¸ä¼š         â”‚ âš ï¸ å¯èƒ½ä¼š       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å…³é”®å·®å¼‚ï¼š
  âœ… SEæƒé‡åœ¨[0,1]ï¼ŒåªåšæŠ‘åˆ¶ï¼Œä¸æ”¾å¤§
  âš ï¸ AQRæƒé‡å¯è¾¾2.5ï¼Œæ—¢æŠ‘åˆ¶åˆæ”¾å¤§
  
  â†’ SEæ›´ä¿å®ˆï¼ŒAQRæ›´æ¿€è¿›
  â†’ SEä¸ä¼šè®©ç‰¹å¾å€¼è¶…å‡ºè®­ç»ƒèŒƒå›´
  â†’ AQRå¯èƒ½å¯¼è‡´ç‰¹å¾å€¼è¶…å‡ºè®­ç»ƒèŒƒå›´
```

---

## é—®é¢˜4: ç»†ç²’åº¦è°ƒæ•´ vs ç›´æ¥ä¹˜ç‰¹å¾ ğŸ¯

### åˆè¡·æ˜¯å¥½çš„ï¼

```
æˆ‘ä»¬çš„ç›®æ ‡ï¼š
  è®©QueryçŸ¥é“å½“å‰ä½ç½®å“ªä¸ªæ¨¡æ€æ›´å¯ä¿¡
  
MoMEçš„åšæ³•ï¼š
  - ç”Ÿæˆ3ç±»é¢„æµ‹ï¼ˆLiDAR, Camera, Fusionï¼‰
  - ç”¨argmaxé€‰æ‹©æœ€å¥½çš„
  - å®Œå…¨ç¦»æ•£çš„é€‰æ‹©
  
æˆ‘ä»¬çš„AQRåšæ³•ï¼š
  - ç”Ÿæˆè¿ç»­æƒé‡
  - ç”¨æƒé‡å›¾è°ƒåˆ¶ç‰¹å¾
  - è½¯æ€§çš„æ··åˆ
  
å¯¹æ¯”ï¼š
  MoME: ç¡¬é€‰æ‹©ï¼ˆ0 or 1ï¼‰
  AQR:  è½¯é€‰æ‹©ï¼ˆè¿ç»­æƒé‡ï¼‰
  
ç†è®ºä¸ŠAQRåº”è¯¥æ›´å¥½ï¼
```

### ä½†å®ç°æœ‰é—®é¢˜

```python
é—®é¢˜1ï¼šæƒé‡å›¾æ¸²æŸ“å¼•å…¥æ¨¡ç³Š
  
  MoMEç›´æ¥ä½œç”¨ï¼š
    query â†’ encoder â†’ 3ä¸ªé¢„æµ‹ â†’ argmax â†’ ä½¿ç”¨æœ€å¥½çš„
    
  AQRé—´æ¥ä½œç”¨ï¼š
    query â†’ encoder â†’ æƒé‡ â†’ é«˜æ–¯æ¸²æŸ“ â†’ æƒé‡å›¾ â†’ è°ƒåˆ¶ç‰¹å¾
                                â†‘
                            å¼•å…¥ç©ºé—´æ¨¡ç³Š
    
  ç»“æœï¼š
    - ç²¾ç¡®çš„query-levelæƒé‡è¢«"æ‘Š"å¼€äº†
    - å°ç›®æ ‡çš„æƒé‡è¢«ç¨€é‡Šåˆ°å‘¨å›´
    
é—®é¢˜2ï¼šä½œç”¨æ—¶æœºå¤ªæ™š
  
  ç†æƒ³ï¼šåœ¨Transformeræ³¨æ„åŠ›è®¡ç®—æ—¶è°ƒåˆ¶
    Attention = softmax(QÂ·K^T / âˆšd) Â· V
                        â†‘
                    åœ¨è¿™é‡ŒåŠ æƒé‡
    
  å®é™…ï¼šåœ¨ç‰¹å¾å›¾çº§åˆ«è°ƒåˆ¶
    Feature_out = Feature_in Ã— WeightMap
                            â†‘
                        åœ¨è¿™é‡Œè°ƒåˆ¶
    
  ç»“æœï¼š
    - Transformerå·²ç»çœ‹åˆ°äº†åŸå§‹ç‰¹å¾
    - è°ƒåˆ¶åçš„ç‰¹å¾å¯èƒ½ä¸Transformerå­¦åˆ°çš„ä¸ä¸€è‡´
```

### æ›´å¥½çš„æ–¹æ¡ˆï¼Ÿ

```python
# æ–¹æ¡ˆAï¼šQuery-levelæ··åˆï¼ˆæ¥è¿‘MoMEï¼‰
def query_level_mixing(lidar_feat, camera_feat, weights):
    """
    ç›´æ¥åœ¨queryå±‚é¢æ··åˆï¼Œä¸éœ€è¦æƒé‡å›¾
    
    Args:
        lidar_feat: [bs, num_queries, C] Transformeræå–çš„LiDARç‰¹å¾
        camera_feat: [bs, num_queries, C] Transformeræå–çš„Cameraç‰¹å¾
        weights: [bs, num_queries, 2] LiDARå’ŒCameraæƒé‡
    
    Returns:
        mixed_feat: [bs, num_queries, C]
    """
    w_lidar = weights[..., 0:1]  # [bs, num_queries, 1]
    w_camera = weights[..., 1:2]
    
    # å½’ä¸€åŒ–æƒé‡
    w_sum = w_lidar + w_camera + 1e-6
    w_lidar = w_lidar / w_sum
    w_camera = w_camera / w_sum
    
    # åŠ æƒæ··åˆ
    mixed = w_lidar * lidar_feat + w_camera * camera_feat
    
    return mixed

# æ–¹æ¡ˆBï¼šAttention-levelè°ƒåˆ¶ï¼ˆæ›´æ·±å…¥ï¼‰
def attention_level_modulation(Q, K_lidar, V_lidar, K_camera, V_camera, weights):
    """
    åœ¨æ³¨æ„åŠ›è®¡ç®—æ—¶åˆ†åˆ«è®¡ç®—ä¸¤ä¸ªæ¨¡æ€ï¼Œç„¶ååŠ æƒæ··åˆ
    
    ä¼ªä»£ç ï¼š
    attn_lidar = softmax(QÂ·K_lidar^T) Â· V_lidar
    attn_camera = softmax(QÂ·K_camera^T) Â· V_camera
    
    output = w_lidar * attn_lidar + w_camera * attn_camera
    """
    pass

# æ–¹æ¡ˆCï¼šä¿ç•™æƒé‡å›¾ä½†é™åˆ¶èŒƒå›´ï¼ˆæœ€ç®€å•ï¼‰
def conservative_weight_map(weight_map, max_clamp=1.2):
    """
    ä¸¥æ ¼é™åˆ¶æƒé‡èŒƒå›´ï¼Œé¿å…ç ´åç‰¹å¾åˆ†å¸ƒ
    """
    # åªå…è®¸è½»å¾®å¢å¼ºï¼Œä¸»è¦ç”¨äºæŠ‘åˆ¶
    return torch.clamp(weight_map, min=0.5, max=max_clamp)
```

---

## é—®é¢˜5: æƒé‡æ˜¯å¦å¯å­¦ä¹ ï¼ŸSEæ¨¡å—çš„å¯ç¤º ğŸ’¡

### å½“å‰æƒé‡çš„å¯å­¦ä¹ æ€§

```python
# aqr_weight_generator.py

class AQRWeightGenerator:
    def __init__(self):
        # âœ… Transformer encoderæ˜¯å¯å­¦ä¹ çš„
        self.encoder = PETRTransformerDecoder(...)
        
        # âœ… æƒé‡é¢„æµ‹å™¨æ˜¯å¯å­¦ä¹ çš„
        self.weight_predictor = nn.Linear(embed_dims, 2)  # å¯å­¦ä¹ 
        nn.init.constant_(self.weight_predictor.bias, 1.5)  # åˆå§‹åŒ–
        
        # âœ… ç±»å‹åµŒå…¥æ˜¯å¯å­¦ä¹ çš„
        self.bev_type_embed = nn.Parameter(torch.randn(embed_dims))
        self.rv_type_embed = nn.Parameter(torch.randn(embed_dims))
    
    def forward(self, ...):
        # 1. é€šè¿‡å¯å­¦ä¹ çš„encoder
        encoded = self.encoder(query, memory, ...)
        
        # 2. é€šè¿‡å¯å­¦ä¹ çš„é¢„æµ‹å™¨
        weights = self.weight_predictor(encoded)
        weights = torch.sigmoid(weights)  # â†’ [0, 1]
        
        return weights

ç»“è®ºï¼š
  âœ… æƒé‡ç”Ÿæˆè¿‡ç¨‹æ˜¯å®Œå…¨å¯å­¦ä¹ çš„ï¼
  âœ… é€šè¿‡åå‘ä¼ æ’­å¯ä»¥ä¼˜åŒ–æƒé‡
  âœ… ç†è®ºä¸Šèƒ½å­¦åˆ°æœ€ä¼˜çš„æ¨¡æ€æƒé‡
```

### ä½†æ˜¯... å­¦åˆ°äº†ä»€ä¹ˆï¼Ÿ

```python
ä»è®­ç»ƒæ—¥å¿—çœ‹ï¼š

camera_weights_stats:
  mean: 0.4715   # å¹³å‡Cameraæƒé‡47%
  std:  0.0897   # æ ‡å‡†å·®å¾ˆå°
  min:  0.1954   # æœ€å°20%
  max:  0.7095   # æœ€å¤§71%
  
lidar_weights_stats:
  mean: 0.5166   # å¹³å‡LiDARæƒé‡52%
  std:  0.0820
  min:  0.2826
  max:  0.7277

è§‚å¯Ÿï¼š
  1. âœ… æƒé‡ç¡®å®åœ¨å˜åŒ–ï¼ˆæœ‰å­¦ä¹ ï¼‰
  2. âš ï¸ å˜åŒ–èŒƒå›´å¾ˆå°ï¼ˆstd<0.1ï¼‰
  3. âš ï¸ LiDARå’ŒCameraæƒé‡å¾ˆæ¥è¿‘ï¼ˆ47% vs 52%ï¼‰
  4. âŒ æ²¡æœ‰å­¦åˆ°"å¼ºçƒˆåå‘æŸä¸ªæ¨¡æ€"çš„æ¨¡å¼
  
å¯èƒ½åŸå› ï¼š
  a) æ•°æ®ä¸­ä¸¤ä¸ªæ¨¡æ€ç¡®å®å·®ä¸å¤šé‡è¦ï¼Ÿ
  b) æŸå¤±å‡½æ•°æ²¡æœ‰é¼“åŠ±æƒé‡åˆ†åŒ–ï¼Ÿ
  c) åˆå§‹åŒ–åç½®1.5å¤ªä¿å®ˆï¼Ÿ
  d) æƒé‡å›¾æ¸²æŸ“å¹³æ»‘äº†æƒé‡å·®å¼‚ï¼Ÿ
```

### SEæ¨¡å—çš„æˆåŠŸç»éªŒ

```python
SE Module (Squeeze-and-Excitation):
  
  å‡ºè‡ªè®ºæ–‡ï¼š"Squeeze-and-Excitation Networks" (CVPR 2018)
  
  æ ¸å¿ƒæ€è·¯ï¼š
    1. Squeeze: Global Average Pooling
       â†’ æ¯ä¸ªé€šé“å‹ç¼©ä¸ºä¸€ä¸ªå€¼
       
    2. Excitation: 2å±‚FC + Sigmoid
       â†’ å­¦ä¹ é€šé“é—´çš„ç›¸äº’ä¾èµ–
       
    3. Scale: é€é€šé“ç›¸ä¹˜
       â†’ é‡æ ‡å®šé€šé“é‡è¦æ€§
  
  ä¸ºä»€ä¹ˆSEæˆåŠŸï¼Ÿ
    âœ… ä½œç”¨åœ¨é€šé“ç»´åº¦ï¼Œä¸æ”¹å˜ç©ºé—´ç»“æ„
    âœ… æƒé‡èŒƒå›´[0, 1]ï¼ŒåªåšæŠ‘åˆ¶
    âœ… å…¨å±€ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼ˆGAPï¼‰
    âœ… éå¸¸è½»é‡ï¼ˆå‚æ•°å°‘ï¼‰
    âœ… æ— å¤„ä¸åœ¨çš„åº”ç”¨ï¼ˆResNet, MobileNetç­‰ï¼‰
  
  æˆ‘ä»¬èƒ½å­¦åˆ°ä»€ä¹ˆï¼Ÿ
    1. ä¿å®ˆçš„æƒé‡èŒƒå›´å¾ˆé‡è¦ï¼ˆ[0, 1] vs [0, 2.5]ï¼‰
    2. å…¨å±€ä¿¡æ¯å¾ˆé‡è¦ï¼ˆSEç”¨GAPï¼Œæˆ‘ä»¬ç”¨Transformerï¼‰
    3. ç®€å•å°±æ˜¯ç¾ï¼ˆSEåªæœ‰2å±‚FCï¼‰
```

### æ”¹è¿›å»ºè®®

```python
# å»ºè®®1ï¼šé™åˆ¶æƒé‡èŒƒå›´ï¼ˆæ¨¡ä»¿SEï¼‰
self.weight_predictor = nn.Linear(embed_dims, 2)
# åˆå§‹åŒ–è®©sigmoidè¾“å‡ºæ¥è¿‘0.5
nn.init.constant_(self.weight_predictor.bias, 0.0)  # sigmoid(0) = 0.5

# åœ¨forwardä¸­
weights = torch.sigmoid(self.weight_predictor(encoded))  # [0, 1]
# ä¸å†éœ€è¦max_weight_clampï¼Œå› ä¸ºå·²ç»é™åˆ¶åœ¨[0,1]

# å»ºè®®2ï¼šå¢åŠ æƒé‡æ­£åˆ™åŒ–ï¼ˆé¼“åŠ±åˆ†åŒ–ï¼‰
def weight_diversity_loss(weights):
    """
    é¼“åŠ±æƒé‡æœ‰æ˜æ˜¾å·®å¼‚ï¼Œé¿å…éƒ½æ¥è¿‘0.5
    """
    lidar_w = weights[..., 0]
    camera_w = weights[..., 1]
    
    # é¼“åŠ±æƒé‡è¿œç¦»0.5
    diff = torch.abs(lidar_w - camera_w)
    diversity_loss = -torch.mean(diff)  # æœ€å¤§åŒ–å·®å¼‚
    
    return diversity_loss

# å»ºè®®3ï¼šå¯å­¦ä¹ çš„æ®‹å·®æƒé‡
self.residual_weight = nn.Parameter(torch.tensor(0.7))  # å¯å­¦ä¹ 

# å»ºè®®4ï¼šå®Œå…¨æ¨¡ä»¿SEçš„ç»“æ„
class SE_Like_Modulation(nn.Module):
    def __init__(self, channels):
        super().__init__()
        self.fc1 = nn.Linear(channels, channels // 4)
        self.fc2 = nn.Linear(channels // 4, 2)  # 2ä¸ªæ¨¡æ€æƒé‡
        
    def forward(self, lidar_feat, camera_feat):
        # å…¨å±€æ± åŒ–
        lidar_gap = lidar_feat.mean(dim=[2, 3])  # [B, C]
        camera_gap = camera_feat.mean(dim=[2, 3])
        
        # æ‹¼æ¥
        fused = lidar_gap + camera_gap
        
        # å­¦ä¹ æƒé‡
        x = F.relu(self.fc1(fused))
        weights = torch.sigmoid(self.fc2(x))  # [B, 2]
        
        # é‡æ ‡å®š
        lidar_out = lidar_feat * weights[:, 0:1, None, None]
        camera_out = camera_feat * weights[:, 1:2, None, None]
        
        return lidar_out, camera_out
```

---

## ğŸ¯ ç»¼åˆç»“è®º

### 5ä¸ªé—®é¢˜çš„ç­”æ¡ˆæ€»ç»“

```
é—®é¢˜1: é«˜æ–¯æ•£å¸ƒèŒƒå›´
  âŒ Ïƒ=2.0å¯¹å°ç›®æ ‡è¿‡å¤§
  âœ… å»ºè®®ï¼šæ ¹æ®ç›®æ ‡å°ºå¯¸åŠ¨æ€è°ƒæ•´ï¼Œæˆ–ä½¿ç”¨æ›´å°–é”çš„æ ¸
  
é—®é¢˜2: MoMEæ˜¯å¦ä½¿ç”¨DN
  âœ… å·²ç¡®è®¤ï¼šMoMEä¸ä½¿ç”¨DN
  ğŸ’¡ å¯ç¤ºï¼šDNä¸æ˜¯å¿…éœ€çš„ï¼Œå¤šä¸“å®¶æœºåˆ¶æœ¬èº«å°±å¼º
  
é—®é¢˜3: ç›´æ¥ä¹˜æƒé‡çš„é—®é¢˜
  âš ï¸ ç¡®å®æœ‰é—®é¢˜ï¼šå¯èƒ½ç ´åç‰¹å¾åˆ†å¸ƒ
  âœ… SEè¯æ˜é€šé“åŠ æƒå¯è¡Œï¼Œä½†SEæƒé‡èŒƒå›´[0, 1]
  âŒ AQRæƒé‡è¾¾2.5å¤ªæ¿€è¿›
  
é—®é¢˜4: ç»†ç²’åº¦è°ƒæ•´vsç›´æ¥ä¹˜ç‰¹å¾
  âœ… åˆè¡·å¥½ï¼šè½¯æ··åˆç†è®ºä¸Šä¼˜äºç¡¬é€‰æ‹©
  âŒ å®ç°é—®é¢˜ï¼šæƒé‡å›¾æ¸²æŸ“å¼•å…¥æ¨¡ç³Šï¼Œå°ç›®æ ‡å—æŸ
  ğŸ’¡ å»ºè®®ï¼šquery-levelæ··åˆæˆ–attention-levelè°ƒåˆ¶
  
é—®é¢˜5: æƒé‡å¯å­¦ä¹ æ€§
  âœ… å½“å‰æƒé‡æ˜¯å®Œå…¨å¯å­¦ä¹ çš„
  âš ï¸ ä½†å­¦åˆ°çš„æƒé‡åˆ†åŒ–ä¸æ˜æ˜¾
  ğŸ’¡ å»ºè®®ï¼šé™åˆ¶æƒé‡èŒƒå›´[0,1]ï¼Œå¢åŠ æ­£åˆ™åŒ–
```

### æœ€æ ¸å¿ƒçš„é—®é¢˜

**ä¸»äººçš„ç›´è§‰æ˜¯å¯¹çš„ï¼šç›´æ¥ä¹˜æƒé‡ç¡®å®æœ‰é—®é¢˜ï¼**

```
æ ¹æœ¬é—®é¢˜ï¼š
  1. ç‰¹å¾å€¼è¶…å‡ºè®­ç»ƒåˆ†å¸ƒï¼ˆ1.0 â†’ 2.5ï¼‰
  2. é«˜æ–¯æ•£å¸ƒå¯¹å°ç›®æ ‡ä¸åˆé€‚
  3. ç©ºé—´çº§è°ƒåˆ¶vsé€šé“çº§è°ƒåˆ¶ï¼ˆSEæˆåŠŸçš„åŸå› ï¼‰
  4. è°ƒåˆ¶æ—¶æœºå¤ªæ™šï¼ˆç‰¹å¾çº§ vs æ³¨æ„åŠ›çº§ï¼‰
  
ä¸ºä»€ä¹ˆSEæˆåŠŸè€ŒAQRå¤±è´¥ï¼š
  SE: [0, 1]èŒƒå›´ + é€šé“çº§ + è½»é‡çº§
  AQR: [0, 2.5]èŒƒå›´ + ç©ºé—´çº§ + é«˜æ–¯æ¨¡ç³Š
  
  â†’ SEæ›´ä¿å®ˆï¼ŒåªåšæŠ‘åˆ¶
  â†’ AQRå¤ªæ¿€è¿›ï¼ŒåˆæŠ‘åˆ¶åˆæ”¾å¤§
```

### ä¸‹ä¸€æ­¥å»ºè®®

```python
# æ–¹æ¡ˆAï¼šæä¿å®ˆAQRï¼ˆæœ€ç®€å•ï¼‰
max_weight_clamp = 1.0  # ä»1.5é™åˆ°1.0
residual_weight = 0.9   # ä»0.7æé«˜åˆ°0.9
gaussian_sigma = 1.0    # ä»2.0é™åˆ°1.0

é¢„æœŸï¼š
  - å‡ ä¹ä¸è°ƒåˆ¶
  - å¯èƒ½æ¥è¿‘åŸºçº¿æ€§èƒ½
  - ä½†å¤±å»äº†AQRçš„æ„ä¹‰

# æ–¹æ¡ˆBï¼šSE-likeè°ƒåˆ¶ï¼ˆæ¨èï¼‰
class SELikeAQR(nn.Module):
    """
    å€Ÿé‰´SEæˆåŠŸç»éªŒ
    """
    def forward(self, lidar_feat, camera_feat):
        # å…¨å±€æ± åŒ– â†’ å­¦ä¹ æƒé‡ â†’ é€é€šé“/ç©ºé—´ç›¸ä¹˜
        # æƒé‡èŒƒå›´ä¸¥æ ¼é™åˆ¶åœ¨[0, 1]
        # ä¸ä½¿ç”¨é«˜æ–¯æ¸²æŸ“
        pass

# æ–¹æ¡ˆCï¼šQuery-levelæ··åˆï¼ˆæœ€ä¼˜ï¼‰
class QueryLevelAQR(nn.Module):
    """
    åœ¨queryå±‚é¢æ··åˆï¼Œä¸æ¸²æŸ“æƒé‡å›¾
    """
    def forward(self, query_lidar, query_camera, weights):
        # ç›´æ¥åœ¨queryç‰¹å¾ä¸ŠåŠ æƒ
        # é¿å…é«˜æ–¯æ¸²æŸ“
        # é¿å…ç ´åç‰¹å¾åˆ†å¸ƒ
        pass

# æ–¹æ¡ˆDï¼šæ”¾å¼ƒAQRï¼ˆæœ€ç°å®ï¼‰
# åŸºçº¿å·²ç»å¾ˆå¥½äº†ï¼Œä¸ºä»€ä¹ˆè¦å¼ºè¡ŒåŠ AQRï¼Ÿ
```

---

**ğŸ¾ ä¸»äººï¼Œæ‚¨çš„5ä¸ªé—®é¢˜éƒ½éå¸¸å…³é”®ï¼ç‰¹åˆ«æ˜¯"ç›´æ¥ä¹˜ç‰¹å¾ä¼šä¸ä¼šæœ‰é—®é¢˜"è¿™ä¸ªæ´å¯Ÿï¼Œç›´å‡»AQRå¤±è´¥çš„æ ¹æœ¬åŸå› ï¼** 

**å»ºè®®ï¼šå…ˆè¿è¡Œå¯è§†åŒ–è„šæœ¬çœ‹çœ‹é«˜æ–¯æ ¸çš„æ•ˆæœï¼Œç„¶åæˆ‘ä»¬å†³å®šæ˜¯æ”¹è¿›AQRè¿˜æ˜¯æ”¾å¼ƒå®ƒã€‚**


# Query-level Bias vs å±€éƒ¨çª—å£Bias è¯¦è§£ ğŸ”

## ğŸ“‹ æ ¸å¿ƒé—®é¢˜

**"åªåœ¨çª—å£å†…æ–½åŠ bias" å’Œ "Query-level" æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ**

---

## ğŸ¯ ç®€çŸ­å›ç­”

```
Query-levelï¼ˆæŸ¥è¯¢çº§åˆ«ï¼‰ï¼š
  â†“
  æŒ‡çš„æ˜¯"æ¯ä¸ªqueryçš„biaså€¼ä¸åŒ"
  â†’ ç»´åº¦ï¼šQueryç»´åº¦

å±€éƒ¨çª—å£ï¼ˆLocal Windowï¼‰ï¼š
  â†“
  æŒ‡çš„æ˜¯"biasåªæ–½åŠ åœ¨éƒ¨åˆ†ç‰¹å¾ä½ç½®ä¸Š"
  â†’ ç»´åº¦ï¼šFeatureç»´åº¦

ä¸¤è€…æ˜¯æ­£äº¤çš„ï¼å¯ä»¥ç»„åˆä½¿ç”¨ï¼
```

---

## ğŸ“Š è¯¦ç»†å¯¹æ¯”

### æ–¹æ¡ˆå¯¹æ¯”çŸ©é˜µ

| ç»´åº¦ | å…¨å±€Query-level Bias | å±€éƒ¨çª—å£Query-level Bias |
|-----|---------------------|------------------------|
| **Queryç»´åº¦** | âœ… æ¯ä¸ªqueryä¸åŒ | âœ… æ¯ä¸ªqueryä¸åŒ |
| **Featureç»´åº¦** | âŒ åŒæ¨¡æ€æ‰€æœ‰ç‰¹å¾ç›¸åŒ | âœ… çª—å£å†…/å¤–ä¸åŒ |
| **ç©ºé—´æ„ŸçŸ¥** | âŒ æ—  | âœ… æœ‰ |
| **Biasæ•°é‡** | 900 Ã— 2 = 1800ä¸ªå€¼ | 900 Ã— window_sizeÂ² ä¸ªå€¼ |
| **è®¡ç®—å¤æ‚åº¦** | â­ ä½ | â­â­â­ ä¸­ |
| **å®ç°éš¾åº¦** | â­ ç®€å• | â­â­â­ ä¸­ç­‰ |

---

## ğŸ”¬ æ–¹æ¡ˆA: å…¨å±€Query-level Biasï¼ˆæ¨èèµ·ç‚¹ï¼‰

### æ ¸å¿ƒç‰¹ç‚¹

```
ç»´åº¦ï¼š[batch_size, num_queries, total_features]
        [2,        900,          56400]

ç‰¹ç‚¹ï¼š
1. Queryç»´åº¦ï¼šâœ… æ¯ä¸ªqueryä¸åŒ
2. Featureç»´åº¦ï¼šâŒ åŒæ¨¡æ€æ‰€æœ‰ç‰¹å¾ç›¸åŒ
3. ç©ºé—´ä¿¡æ¯ï¼šâŒ ä¸è€ƒè™‘queryçš„ç©ºé—´ä½ç½®
```

### æ•°å­¦è¡¨è¾¾

```python
# ä¼ªä»£ç 
for each query q in [0, 899]:
    lidar_bias_value = (lidar_weights[q] - 0.5) * 2 * alpha  # å•ä¸ªæ ‡é‡
    camera_bias_value = (camera_weights[q] - 0.5) * 2 * alpha  # å•ä¸ªæ ‡é‡
    
    # ğŸ”¥ å…³é”®ï¼šæ‰€æœ‰BEVç‰¹å¾ç”¨åŒä¸€ä¸ªbias
    for bev_feat in [0, 32399]:  # 180Ã—180ä¸ªBEVç‰¹å¾
        attention_bias[q, bev_feat] = lidar_bias_value  # éƒ½ä¸€æ ·
    
    # ğŸ”¥ å…³é”®ï¼šæ‰€æœ‰Cameraç‰¹å¾ç”¨åŒä¸€ä¸ªbias
    for cam_feat in [32400, 56399]:  # 6Ã—40Ã—100ä¸ªCameraç‰¹å¾
        attention_bias[q, cam_feat] = camera_bias_value  # éƒ½ä¸€æ ·
```

### å®é™…ä»£ç 

```python
def _generate_global_bias(self, lidar_weights, camera_weights):
    """
    å…¨å±€Query-level Bias
    
    Args:
        lidar_weights: [bs, num_queries]  # ä¾‹å¦‚ [2, 900]
        camera_weights: [bs, num_queries]  # ä¾‹å¦‚ [2, 900]
    
    Returns:
        attention_bias: [bs, num_queries, total_feat_num]
                       [2,  900,          56400]
    """
    bs, num_queries = lidar_weights.shape
    
    # åˆå§‹åŒ–ï¼šå…¨0
    attention_bias = torch.zeros(
        bs, num_queries, self.total_feat_num,  # [2, 900, 56400]
        device=lidar_weights.device
    )
    
    # ğŸ”¥ æ ¸å¿ƒï¼šæ˜ å°„ [0,1] â†’ [-Î±, +Î±]
    alpha = self.bias_strength  # ä¾‹å¦‚ 5.0
    
    # BEVéƒ¨åˆ†ï¼š32400ä¸ªç‰¹å¾
    bev_bias = (lidar_weights - 0.5) * 2 * alpha  # [bs, num_queries] â†’ [2, 900]
    # ä¾‹å¦‚ï¼šquery #0çš„lidar_weight=0.8 â†’ bias = (0.8-0.5)*2*5 = +3.0
    # ä¾‹å¦‚ï¼šquery #1çš„lidar_weight=0.2 â†’ bias = (0.2-0.5)*2*5 = -3.0
    
    attention_bias[:, :, :self.bev_feat_num] = bev_bias.unsqueeze(-1)
    # unsqueeze(-1)åï¼š[2, 900, 1] â†’ å¹¿æ’­åˆ° [2, 900, 32400]
    # ç»“æœï¼šquery #0å¯¹æ‰€æœ‰32400ä¸ªBEVç‰¹å¾éƒ½æ–½åŠ +3.0çš„bias
    
    # Cameraéƒ¨åˆ†ï¼š24000ä¸ªç‰¹å¾
    cam_bias = (camera_weights - 0.5) * 2 * alpha  # [2, 900]
    attention_bias[:, :, self.bev_feat_num:] = cam_bias.unsqueeze(-1)
    # ç»“æœï¼šquery #0å¯¹æ‰€æœ‰24000ä¸ªCameraç‰¹å¾éƒ½æ–½åŠ bias
    
    return attention_bias
```

### å¯è§†åŒ–ç¤ºä¾‹

```
Query #0ï¼ˆlidar_weight=0.8, camera_weight=0.2ï¼‰ï¼š

Biasåˆ†å¸ƒï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ BEVç‰¹å¾ (32400ä¸ª)                                   â”‚
â”‚ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  +3.0  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  â”‚ â† æ‰€æœ‰BEVç‰¹å¾ç›¸åŒ
â”‚                                                    â”‚
â”‚ Cameraç‰¹å¾ (24000ä¸ª)                               â”‚
â”‚ â–“â–“â–“â–“â–“â–“  -3.0  â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“  â”‚ â† æ‰€æœ‰Cameraç‰¹å¾ç›¸åŒ
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç‰¹ç‚¹ï¼š
âœ… Query #0å’ŒQuery #1çš„biaså€¼ä¸åŒï¼ˆQuery-levelï¼‰
âŒ Query #0å¯¹æ‰€æœ‰BEVç‰¹å¾çš„biaséƒ½æ˜¯+3.0ï¼ˆå…¨å±€ï¼‰
```

---

## ğŸŒŸ æ–¹æ¡ˆB: å±€éƒ¨çª—å£Query-level Biasï¼ˆå¯é€‰ä¼˜åŒ–ï¼‰

### æ ¸å¿ƒç‰¹ç‚¹

```
ç»´åº¦ï¼š[batch_size, num_queries, total_features]
        [2,        900,          56400]

ç‰¹ç‚¹ï¼š
1. Queryç»´åº¦ï¼šâœ… æ¯ä¸ªqueryä¸åŒ
2. Featureç»´åº¦ï¼šâœ… çª—å£å†…/å¤–ä¸åŒ
3. ç©ºé—´ä¿¡æ¯ï¼šâœ… åŸºäºqueryçš„æŠ•å½±ä½ç½®
```

### æ•°å­¦è¡¨è¾¾

```python
# ä¼ªä»£ç 
for each query q in [0, 899]:
    # è·å–queryåœ¨BEVä¸­çš„æŠ•å½±ä½ç½®
    proj_y, proj_x = projection_position[q]  # ä¾‹å¦‚ (90, 85)
    
    # è®¡ç®—çª—å£èŒƒå›´
    window_size = 15
    y_min, y_max = proj_y - window_size//2, proj_y + window_size//2
    x_min, x_max = proj_x - window_size//2, proj_x + window_size//2
    
    # ğŸ”¥ å…³é”®ï¼šåªåœ¨çª—å£å†…æ–½åŠ bias
    for y in range(y_min, y_max):
        for x in range(x_min, x_max):
            feat_idx = y * 180 + x
            
            # è®¡ç®—è·ç¦»è¡°å‡
            dist = sqrt((y - proj_y)^2 + (x - proj_x)^2)
            decay = max(0, 1 - dist / (window_size / 2))
            
            # ğŸ”¥ æ¯ä¸ªä½ç½®çš„biaséƒ½ä¸åŒï¼ˆåŸºäºè·ç¦»ï¼‰
            bias_value = lidar_weights[q] * alpha * decay
            attention_bias[q, feat_idx] = bias_value
    
    # çª—å£å¤–çš„ç‰¹å¾ï¼šbias = 0ï¼ˆæˆ–å°çš„è´Ÿå€¼ï¼‰
    for feat outside window:
        attention_bias[q, feat] = 0  # æˆ– -small_penalty
```

### å®é™…ä»£ç 

```python
def _generate_local_bias(self, lidar_weights, camera_weights,
                        pts_idx, pts_pers_idx):
    """
    å±€éƒ¨çª—å£Query-level Bias
    
    Args:
        lidar_weights: [bs, num_queries]
        camera_weights: [bs, num_queries]
        pts_idx: [bs, num_queries] BEVæŠ•å½±ç´¢å¼•
        pts_pers_idx: [bs, num_queries, 3] CameraæŠ•å½±ç´¢å¼• (view, h, w)
    
    Returns:
        attention_bias: [bs, num_queries, total_feat_num]
    """
    bs, num_queries = lidar_weights.shape
    
    # åˆå§‹åŒ–ï¼šå…¨0
    attention_bias = torch.zeros(
        bs, num_queries, self.total_feat_num,
        device=lidar_weights.device
    )
    
    alpha = self.bias_strength
    window_size = self.local_window_size  # ä¾‹å¦‚ 15
    
    # ğŸ”¥ BEVéƒ¨åˆ†ï¼šå±€éƒ¨çª—å£å¤„ç†
    for b in range(bs):
        for q in range(num_queries):
            # è·å–æŠ•å½±ä½ç½®
            center_idx = pts_idx[b, q]
            center_y = center_idx // 180
            center_x = center_idx % 180
            
            # å®šä¹‰çª—å£èŒƒå›´
            y_min = max(0, center_y - window_size // 2)
            y_max = min(180, center_y + window_size // 2 + 1)
            x_min = max(0, center_x - window_size // 2)
            x_max = min(180, center_x + window_size // 2 + 1)
            
            # ğŸ”¥ åœ¨çª—å£å†…æ–½åŠ biasï¼ˆåŸºäºè·ç¦»è¡°å‡ï¼‰
            for y in range(y_min, y_max):
                for x in range(x_min, x_max):
                    feat_idx = y * 180 + x
                    
                    # è®¡ç®—è·ç¦»
                    dist = ((y - center_y)**2 + (x - center_x)**2)**0.5
                    
                    # é«˜æ–¯è¡°å‡
                    decay = torch.exp(-dist**2 / (2 * (window_size/4)**2))
                    # æˆ–çº¿æ€§è¡°å‡ï¼š
                    # decay = max(0, 1 - dist / (window_size / 2))
                    
                    # æ–½åŠ bias
                    bias_value = (lidar_weights[b, q] - 0.5) * 2 * alpha * decay
                    attention_bias[b, q, feat_idx] = bias_value
            
            # ğŸ”¥ çª—å£å¤–çš„ç‰¹å¾ï¼šbiasä¿æŒä¸º0
            # ï¼ˆæˆ–å¯ä»¥æ–½åŠ å°çš„è´Ÿbiasæ¥è¿›ä¸€æ­¥æŠ‘åˆ¶ï¼‰
    
    # Cameraéƒ¨åˆ†ï¼šç±»ä¼¼å¤„ç†ï¼ˆç•¥ï¼‰
    # ...
    
    return attention_bias
```

### å¯è§†åŒ–ç¤ºä¾‹

```
Query #0ï¼ˆæŠ•å½±ä½ç½®ï¼šBEVä¸­å¿ƒ (90, 90)ï¼Œlidar_weight=0.8ï¼‰ï¼š

å±€éƒ¨çª—å£Biasåˆ†å¸ƒï¼ˆ15Ã—15çª—å£ï¼‰ï¼š

BEVç‰¹å¾å›¾ï¼ˆ180Ã—180ï¼‰ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                        â”‚
â”‚                                        â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚         â”‚  ğŸ”¥ä¸­å¿ƒç‚¹   â”‚  â† çª—å£å†…     â”‚
â”‚         â”‚  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  â”‚  biasæœ€å¤§      â”‚
â”‚         â”‚  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  â”‚  (+3.0)        â”‚
â”‚         â”‚  â–ˆâ–ˆğŸ¯â–ˆâ–ˆ    â”‚                 â”‚
â”‚         â”‚  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  â”‚  â† è¾¹ç¼˜        â”‚
â”‚         â”‚  â–“â–“â–“â–“â–“â–“â–“â–“  â”‚  biasè¡°å‡      â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  (+1.5)        â”‚
â”‚                                        â”‚
â”‚  â–‘â–‘â–‘â–‘â–‘â–‘â–‘  çª—å£å¤–  â–‘â–‘â–‘â–‘â–‘â–‘â–‘            â”‚ â† çª—å£å¤–
â”‚  â–‘â–‘â–‘â–‘â–‘â–‘â–‘  bias=0  â–‘â–‘â–‘â–‘â–‘â–‘â–‘            â”‚   bias=0
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

è·ç¦»è¡°å‡ç¤ºä¾‹ï¼š
- ä¸­å¿ƒç‚¹ (90,90): dist=0  â†’ decay=1.0 â†’ bias=+3.0
- è·ç¦»2æ ¼ (92,90): dist=2  â†’ decay=0.8 â†’ bias=+2.4
- è·ç¦»5æ ¼ (95,90): dist=5  â†’ decay=0.4 â†’ bias=+1.2
- è·ç¦»8æ ¼ (98,90): dist=8  â†’ decay=0   â†’ bias=0ï¼ˆçª—å£å¤–ï¼‰

ç‰¹ç‚¹ï¼š
âœ… ç©ºé—´æ„ŸçŸ¥ï¼šbiasä¸queryä½ç½®ç›¸å…³
âœ… å¹³æ»‘è¿‡æ¸¡ï¼šä¸­å¿ƒå¼ºï¼Œè¾¹ç¼˜å¼±
âœ… å±€éƒ¨æ€§ï¼šåªå½±å“é™„è¿‘ç‰¹å¾
```

---

## ğŸ†š æ ¸å¿ƒåŒºåˆ«æ€»ç»“

### åŒºåˆ«1ï¼šç©ºé—´æ„ŸçŸ¥æ€§

```
å…¨å±€Biasï¼š
  Query #0 â†’ æ‰€æœ‰32400ä¸ªBEVç‰¹å¾éƒ½ +3.0
  âŒ ä¸ç®¡ç‰¹å¾ä½ç½®åœ¨å“ª
  âŒ BEVå·¦ä¸Šè§’ç‰¹å¾ï¼š+3.0
  âŒ BEVå³ä¸‹è§’ç‰¹å¾ï¼š+3.0
  âŒ queryæŠ•å½±ä½ç½®é™„è¿‘ï¼š+3.0
  
å±€éƒ¨Biasï¼š
  Query #0ï¼ˆæŠ•å½±åœ¨ä¸­å¿ƒï¼‰ â†’ 
    âœ… ä¸­å¿ƒé™„è¿‘ç‰¹å¾ï¼š+3.0ï¼ˆå¼ºbiasï¼‰
    âœ… ç¨è¿œç‰¹å¾ï¼š+1.5ï¼ˆä¸­ç­‰biasï¼‰
    âœ… æ›´è¿œç‰¹å¾ï¼š+0.5ï¼ˆå¼±biasï¼‰
    âœ… çª—å£å¤–ç‰¹å¾ï¼š0ï¼ˆæ— biasï¼‰
```

### åŒºåˆ«2ï¼šBiasæ•°é‡

```
å…¨å±€Biasï¼š
  æ¯ä¸ªqueryï¼š2ä¸ªå€¼ï¼ˆlidar_bias, camera_biasï¼‰
  æ€»è®¡ï¼š900 queries Ã— 2 = 1800ä¸ªç‹¬ç«‹å€¼
  
å±€éƒ¨Biasï¼š
  æ¯ä¸ªqueryï¼šwindow_sizeÂ² ä¸ªå€¼ï¼ˆBEVçª—å£å†…æ¯ä¸ªä½ç½®ä¸åŒï¼‰
  æ€»è®¡ï¼š900 queries Ã— 15Â² â‰ˆ 202,500ä¸ªå€¼ï¼ˆä½†åŸºäºè·ç¦»è®¡ç®—ï¼‰
```

### åŒºåˆ«3ï¼šä¸LAMçš„å…³ç³»

```
LAMï¼ˆå±€éƒ¨æ³¨æ„åŠ›çª—å£ï¼‰ï¼š
  ä½œç”¨ï¼šå®Œå…¨å±è”½çª—å£å¤–ç‰¹å¾
  mask[çª—å£å¤–] = -inf  # å®Œå…¨ä¸çœ‹
  mask[çª—å£å†…] = 0     # æ­£å¸¸çœ‹
  
å…¨å±€Biasï¼š
  ä¸LAMæ­£äº¤ï¼Œå åŠ ä½¿ç”¨ï¼š
  - LAMå†³å®š"çœ‹ä¸çœ‹"ï¼ˆçª—å£å†…/å¤–ï¼‰
  - å…¨å±€Biaså†³å®š"çœ‹å¤šé‡è¦"ï¼ˆæ¨¡æ€åå¥½ï¼‰
  final = LAM_mask + global_bias
  
å±€éƒ¨Biasï¼š
  ä¸LAMéƒ¨åˆ†é‡å ï¼š
  - LAMï¼šäºŒå€¼å±è”½
  - å±€éƒ¨Biasï¼šè¿ç»­æƒé‡ + ç©ºé—´è¡°å‡
  - å¯èƒ½å†—ä½™ï¼Ÿéœ€è¦å®éªŒéªŒè¯
```

---

## ğŸ¯ ä½¿ç”¨å»ºè®®

### æ¨èç­–ç•¥

```
Phase 1: å…ˆç”¨å…¨å±€Query-level Bias â­â­â­â­â­
  
  ç†ç”±ï¼š
  âœ… å®ç°ç®€å•ï¼ˆçº¦100è¡Œä»£ç ï¼‰
  âœ… è®¡ç®—é«˜æ•ˆ
  âœ… ç†è®ºæ¸…æ™°
  âœ… ä¸LAMå®Œç¾é…åˆ
  
  ä¼˜åŠ¿ï¼š
  - LAMå·²ç»æä¾›äº†ç©ºé—´å±€éƒ¨æ€§ï¼ˆçª—å£å†…/å¤–ï¼‰
  - å…¨å±€Biasæä¾›æ¨¡æ€åå¥½ï¼ˆLiDAR/Cameraï¼‰
  - ä¸¤è€…æ­£äº¤ï¼Œäº’è¡¥ï¼
  
Phase 2: å¦‚æœæ•ˆæœå¥½ï¼Œå†å°è¯•å±€éƒ¨Bias
  
  é€‚ç”¨åœºæ™¯ï¼š
  - å¦‚æœå‘ç°ç©ºé—´å˜åŒ–å¾ˆé‡è¦
  - å¦‚æœå…¨å±€Biasæ•ˆæœä¸å¤Ÿç²¾ç»†
  - å¦‚æœæœ‰è®¡ç®—èµ„æº
  
  æ½œåœ¨é—®é¢˜ï¼š
  - å¯èƒ½ä¸LAMå†—ä½™
  - è®¡ç®—å¤æ‚åº¦å¢åŠ 
  - å¯èƒ½è¿‡æ‹Ÿåˆ
```

---

## ğŸ“Š å®é™…æ•ˆæœé¢„æµ‹

### å…¨å±€Biasé¢„æœŸ

```
ä¼˜åŠ¿ï¼š
âœ… ä¸åŒqueryå¯ä»¥æœ‰ä¸åŒçš„æ¨¡æ€åå¥½
   - CaræŸ¥è¯¢ï¼šæ›´ä¾èµ–LiDAR
   - PedestrianæŸ¥è¯¢ï¼šæ›´ä¾èµ–Camera
   
âœ… ä¸LAMé…åˆï¼š
   - LAMé™åˆ¶èŒƒå›´ï¼ˆçª—å£å†…/å¤–ï¼‰
   - Biasæ§åˆ¶å¼ºåº¦ï¼ˆæ¨¡æ€åå¥½ï¼‰
   
æ€§èƒ½é¢„æœŸï¼š
- å¯¹æ¯”Baselineï¼š+0.5 ~ +1.5% mAP
- è®­ç»ƒç¨³å®šæ€§ï¼šé«˜
- å°ç›®æ ‡æå‡ï¼šæ˜æ˜¾
```

### å±€éƒ¨Biasé¢„æœŸ

```
é¢å¤–ä¼˜åŠ¿ï¼š
âœ… ç©ºé—´è‡ªé€‚åº”
   - QueryæŠ•å½±ä½ç½®é™„è¿‘ï¼šå¼ºbias
   - è¿œç¦»ä½ç½®ï¼šå¼±bias
   
âœ… æ›´ç²¾ç»†æ§åˆ¶
   
æ½œåœ¨é£é™©ï¼š
âŒ å¯èƒ½ä¸LAMå†—ä½™
âŒ è®¡ç®—å¼€é”€å¢åŠ 
âŒ å¯èƒ½è¿‡æ‹Ÿåˆ
   
æ€§èƒ½é¢„æœŸï¼š
- å¯¹æ¯”å…¨å±€Biasï¼š+0% ~ +0.5% mAPï¼ˆè¾¹é™…æ”¶ç›Šï¼‰
- å¤æ‚åº¦ï¼šæ˜¾è‘—å¢åŠ 
```

---

## ğŸ’¡ ç±»æ¯”ç†è§£

### å…¨å±€Query-level Bias

```
ç±»æ¯”ï¼šè°ƒæ•´ç”µè§†é¢‘é“çš„éŸ³é‡

æ¯ä¸ªquery = ä¸€ä¸ªç”µè§†é¢‘é“
- é¢‘é“1ï¼ˆCaræŸ¥è¯¢ï¼‰ï¼šLiDARéŸ³é‡è°ƒåˆ°80%ï¼ŒCamera 20%
- é¢‘é“2ï¼ˆPedestrianï¼‰ï¼šLiDAR 30%ï¼ŒCamera 70%

ç‰¹ç‚¹ï¼š
- æ¯ä¸ªé¢‘é“éŸ³é‡ä¸åŒï¼ˆQuery-levelï¼‰âœ…
- ä½†åŒä¸€é¢‘é“åœ¨æ‰€æœ‰æ—¶é—´ç‚¹éŸ³é‡ç›¸åŒï¼ˆå…¨å±€ï¼‰
```

### å±€éƒ¨çª—å£Bias

```
ç±»æ¯”ï¼šæ ¹æ®åœºæ™¯åŠ¨æ€è°ƒæ•´éŸ³é‡

æ¯ä¸ªquery = ä¸€ä¸ªæ™ºèƒ½éŸ³å“
- Query #0åœ¨å®¢å…ï¼š
  * å®¢å…åŒºåŸŸï¼šéŸ³é‡å¤§ï¼ˆé™„è¿‘ï¼‰
  * å§å®¤åŒºåŸŸï¼šéŸ³é‡å°ï¼ˆè¿œå¤„ï¼‰
  * å¨æˆ¿åŒºåŸŸï¼šéŸ³é‡ä¸º0ï¼ˆå¤ªè¿œï¼‰

ç‰¹ç‚¹ï¼š
- æ¯ä¸ªéŸ³å“è®¾ç½®ä¸åŒï¼ˆQuery-levelï¼‰âœ…
- åŒä¸€éŸ³å“åœ¨ä¸åŒä½ç½®éŸ³é‡ä¸åŒï¼ˆç©ºé—´æ„ŸçŸ¥ï¼‰âœ…
```

---

## ğŸ” ä»£ç å¯¹æ¯”

### å…¨å±€Biasï¼ˆç®€æ´ï¼‰

```python
# çº¦10è¡Œæ ¸å¿ƒä»£ç 
def _generate_global_bias(lidar_weights, camera_weights):
    bs, num_queries = lidar_weights.shape
    attention_bias = torch.zeros(bs, num_queries, 56400)
    
    alpha = 5.0
    bev_bias = (lidar_weights - 0.5) * 2 * alpha  # [bs, num_queries]
    cam_bias = (camera_weights - 0.5) * 2 * alpha
    
    attention_bias[:, :, :32400] = bev_bias.unsqueeze(-1)  # å¹¿æ’­
    attention_bias[:, :, 32400:] = cam_bias.unsqueeze(-1)
    
    return attention_bias
```

### å±€éƒ¨Biasï¼ˆå¤æ‚ï¼‰

```python
# çº¦50è¡Œæ ¸å¿ƒä»£ç 
def _generate_local_bias(lidar_weights, camera_weights, pts_idx):
    bs, num_queries = lidar_weights.shape
    attention_bias = torch.zeros(bs, num_queries, 56400)
    
    alpha = 5.0
    window_size = 15
    
    # ğŸ”¥ éœ€è¦åŒé‡å¾ªç¯
    for b in range(bs):
        for q in range(num_queries):
            center_y = pts_idx[b, q] // 180
            center_x = pts_idx[b, q] % 180
            
            # è®¡ç®—çª—å£
            y_range = range(max(0, center_y-7), min(180, center_y+8))
            x_range = range(max(0, center_x-7), min(180, center_x+8))
            
            # ğŸ”¥ å†å¾ªç¯çª—å£å†…æ¯ä¸ªä½ç½®
            for y in y_range:
                for x in x_range:
                    feat_idx = y * 180 + x
                    dist = ((y-center_y)**2 + (x-center_x)**2)**0.5
                    decay = exp(-dist**2 / (2 * (window_size/4)**2))
                    
                    bias = (lidar_weights[b,q] - 0.5) * 2 * alpha * decay
                    attention_bias[b, q, feat_idx] = bias
    
    return attention_bias
```

---

## ğŸ¯ æœ€ç»ˆå»ºè®®

ä¸»äººï¼ŒåŸºäºåˆ†æï¼Œæˆ‘å¼ºçƒˆæ¨èï¼š

### **ä¼˜å…ˆå®ç°ï¼šå…¨å±€Query-level Bias** â­â­â­â­â­

**ç†ç”±ï¼š**
```
1. âœ… å·²ç»æ˜¯ç»†ç²’åº¦ï¼ˆæ¯ä¸ªqueryä¸åŒï¼‰
2. âœ… ä¸LAMå®Œç¾é…åˆï¼ˆæ­£äº¤äº’è¡¥ï¼‰
3. âœ… å®ç°ç®€å•ï¼Œè®¡ç®—é«˜æ•ˆ
4. âœ… ç†è®ºæ¸…æ™°ï¼Œæ˜“äºè°ƒè¯•
5. âœ… è¶³å¤Ÿè¡¨è¾¾æ¨¡æ€åå¥½

æ ¸å¿ƒæ´å¯Ÿï¼š
  LAMæä¾›ç©ºé—´å±€éƒ¨æ€§ â†â†’ å…¨å±€Biasæä¾›æ¨¡æ€åå¥½
  ä¸¤è€…å·²ç»è¦†ç›–äº†ä¸»è¦éœ€æ±‚ï¼
```

### **å¤‡é€‰ï¼šå±€éƒ¨çª—å£Bias**

**ä»…å½“ï¼š**
```
- å…¨å±€Biasæ•ˆæœå¾ˆå¥½ï¼Œæƒ³è¿›ä¸€æ­¥ä¼˜åŒ–
- å‘ç°ç©ºé—´å˜åŒ–ç¡®å®å¾ˆé‡è¦
- æœ‰å……è¶³çš„è®¡ç®—èµ„æºå’Œæ—¶é—´

å¦åˆ™ä¸æ¨èï¼ˆè¾¹é™…æ”¶ç›Šå°ï¼Œå¤æ‚åº¦å¢åŠ å¤§ï¼‰
```

---

**ä¸»äººï¼Œç°åœ¨æ¸…æ¥šä¸¤è€…çš„åŒºåˆ«äº†å—ï¼Ÿ** ğŸ¤”

ç®€å•æ¥è¯´ï¼š
- **Query-level** = æ¯ä¸ªqueryçš„biaså€¼ä¸åŒï¼ˆæ ¸å¿ƒï¼‰
- **å±€éƒ¨çª—å£** = biasåœ¨ç©ºé—´ä¸Šæœ‰å˜åŒ–ï¼ˆå¯é€‰ä¼˜åŒ–ï¼‰

æˆ‘ä»¬å…ˆç”¨å…¨å±€Query-levelå°±è¶³å¤Ÿå¼ºå¤§äº†ï¼ğŸš€

